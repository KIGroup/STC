<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="stc/js/controllers/TrainingCtrl.js" application="/csp/stc/" default="1"><![CDATA[
'use strict';
//dddeddddddddв

/*===========================================================================================
Обучение
===========================================================================================*/

controllersModule.controller('TrainingCtrl', function($scope, $route, $location, $filter, $routeParams, UtilsSrvc, OrderSrvc, ReportSrvc, TrainingSrvc, CompanySrvc, PersonSrvc, CertificateSrvc){    
    if ($scope.menu.admin){
    	$scope.menu.brandCaption = 'Система учёта курсов';
    	$scope.menu.appTitle = 'Система учёта курсов';
    }
    	
    $scope.training = {};
    $scope.sgroup = {contract:{}};
    $scope.cert = {};
    $scope.feedBack = {};
    $scope.newstud = {};
    $scope.student = {};
    $scope.allstud = {};
    $scope.other = {email:{}};

    if (!$scope.pageStore.training || $scope.pageStore.training.id != $routeParams.id)
        $scope.pageStore.training = {id: $routeParams.id, tabSgActive: false, tabSgStActive: false, tabAllStudActive: false, tabCertsActive: false, tabNewStudActive: false};

    $scope.pageStore.trainingCertificates = {grid:{}};
    $scope.pageStore.newstud = {grid:{}};
    $scope.pageStore.feedBack = {grid:{}};
    $scope.pageStore.allstud = {grid:{}};

    $scope.other.init = function(){
        //============================== ПОДГРУППЫ ==========================================================================
		    $scope.sgroup.columns = [
                          {name: 'Плательщик',    sqlName: 'SubGroups->Payer->ShortName->Value', isSorted: true,  isSortable: true,   isDown: true, isSearched: true,  isSearchable: true},
                          {name: 'Слушатели',     sqlName: '',                                   isSorted: false, isSortable: false,  isDown: true,  isSearched: false, isSearchable: false},
                          {name: 'Сумма к оплате',sqlName: '',                                   isSorted: false, isSortable: false,  isDown: true,  isSearched: false, isSearchable: false},
                          {name: 'Валюта',        sqlName: 'SubGroups->Currency->Name->Value',   isSorted: false, isSortable: true,   isDown: true,  isSearched: false, isSearchable: true}];
                          
        $scope.sgroup.properties = [{name:'payer.shortName'}, {name:'students.length'}, {name:'amount'}, {name:'currency.name'}];
        $scope.sgroup.pageSize = 10;
        $scope.sgroup.pageCurr = 1;
        $scope.sgroup.itemsTotal = 0;
        $scope.sgroup.selectedItems = [];
        $scope.sgroup.multiSelectMode = false;
        $scope.sgroup.forciblyUpdate = 0;

        //$scope.sgroup.loadCurrencies();
		
        //============================== СЕРТИФИКАТЫ ==========================================================================
        $scope.cert.columns = [
                          {name: 'Курс',          sqlName: 'Training->Course->Name->Value', isSorted: false, isSortable: true, isDown: true,  isSearched: true,  isSearchable: true},
                          {name: 'Номер',         sqlName: 'Number',                        isSorted: true, isSortable: true, isDown: true,  isSearched: false, isSearchable: true},
                          {name: 'Слушатель',     sqlName: 'Student->LastName->Value',      isSorted: false, isSortable: true, isDown: true,  isSearched: false, isSearchable: true},
                          {name: 'Организация',      sqlName: '',                              isSorted: false, isSortable: false,isDown: true,  isSearched: false, isSearchable: false},
                          {name: 'Дата создания', sqlName: 'CreatedDate',                   isSorted: false,  isSortable: true, isDown: false, isSearched: false, isSearchable: false, filter: 'date'},
                          {name: 'Статус',        sqlName: 'isPrinted',                     isSorted: false, isSortable: true, isDown: true,  isSearched: false, isSearchable: true}];
        
        $scope.cert.properties = [{name:'training.course.name'}, 
                                  {name:'number'},
                                  {name:'student.fullName', 
                                  calculate: function(item){
                                                item.student.fullName = item.student.lastName + ' ' + item.student.firstName + ' ' + item.student.middleName;
                                  }}, 
                                  {name:'student.company.shortName'},
                                  {name:'date', filter: 'date', filterParam: $filter('localize')('d MMMM y')}, 
                                  {name:'status', 
                                  getCssClass: function(item){
                                                return 'label ' + (item.isPrinted == 0 ? 'label-important' : 'label-success');
                                              }, 
                                  calculate: function(item){
                                                item.status = item.isPrinted == 1 ? $filter('localize')('Распечатан') : $filter('localize')('Не распечатан');
                                  }}];

        $scope.cert.pageSize = UtilsSrvc.getPropertyValue($scope.pageStore, 'trainingCertificates.grid.pageSize', 15);
        $scope.cert.pageCurr = UtilsSrvc.getPropertyValue($scope.pageStore, 'trainingCertificates.grid.pageCurr', 1);
        $scope.cert.itemsTotal = 0;
        $scope.cert.selectedItems = [];
        $scope.cert.multiSelectMode = false;
        $scope.cert.forciblyUpdate = 0;
        $scope.cert.actionColumnVisible = true;

        //$scope.cert.forciblyUpdate++; 

        //============================== ОТЗЫВЫ =======================================================================================
        $scope.feedBack.columns = [
                          {name: 'Оценка',        sqlName: 'Rating',           isSorted: false, isSortable: true, isDown: true,  isSearched: true,  isSearchable: true},
                          {name: 'Автор',         sqlName: 'Author',           isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: true},
                          {name: 'Понравилось',   sqlName: 'WhatLiked',        isSorted: false, isSortable: true, isDown: true,  isSearched: false, isSearchable: false},
                          {name: 'Улучшения',     sqlName: 'WhatImprovements', isSorted: false, isSortable: true, isDown: true,  isSearched: false, isSearchable: false},
                          {name: 'Дополнение',    sqlName: 'WhatHear',         isSorted: false, isSortable: true, isDown: true,  isSearched: false, isSearchable: false},
                          {name: 'О докладчике',  sqlName: 'AboutTeacher',     isSorted: false, isSortable: true, isDown: true,  isSearched: false, isSearchable: true},
                          {name: 'Дата создания', sqlName: 'CreatedTS',        isSorted: true,  isSortable: true, isDown: false, isSearched: false, isSearchable: false, filter: 'date'}];
 
        $scope.feedBack.properties = [{name:'rating'}, 
                                     {name: 'author'},
                                     {name:'whatLikedStatus',        calculate: function(item){ item.whatLikedStatus       = item.whatLiked       =='' ? '' : $filter('localize')('Есть отзыв')}},
                                     {name:'whatImprovementsStatus', calculate: function(item){ item.whatImprovementsStatus= item.whatImprovements=='' ? '' : $filter('localize')('Есть отзыв')}},
                                     {name:'whatHearStatus',         calculate: function(item){ item.whatHearStatus        = item.whatHear        =='' ? '' : $filter('localize')('Есть отзыв')}},
                                     {name:'aboutTeacherStatus',     calculate: function(item){ item.aboutTeacherStatus    = item.aboutTeacher    =='' ? '' : $filter('localize')('Есть отзыв')}},
                                     {name:'createdTS', filter: 'date', filterParam: $filter('localize')('d MMMM y, HH:mm:ss')}];

        $scope.feedBack.pageSize = UtilsSrvc.getPropertyValue($scope.pageStore, 'feedBack.grid.pageSize', 10);
        $scope.feedBack.pageCurr = UtilsSrvc.getPropertyValue($scope.pageStore, 'feedBack.grid.pageCurr', 1);
        $scope.feedBack.itemsTotal = 0;
        $scope.feedBack.selectedItems = [];
        $scope.feedBack.multiSelectMode = false;
        $scope.feedBack.forciblyUpdate = 0;

        //============================== НОВЫЕ СЛУШАТЕЛИ ==========================================================================
        $scope.newstud.columns = [
                          {name: 'Фамилия',       sqlName: 'LastName->Value',           isSorted: false, isSortable: true, isDown: true,  isSearched: true, isSearchable: true},
                          {name: 'Имя',           sqlName: 'FirstName->Value',          isSorted: false, isSortable: true, isDown: true,  isSearched: false, isSearchable: false},
                          {name: 'Отчество',      sqlName: 'MiddleName->Value',         isSorted: false, isSortable: true, isDown: true,  isSearched: false, isSearchable: false},
                          {name: 'Организация',      sqlName: 'Company->ShortName->Value', isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: true},
                          {name: 'Email',         sqlName: 'Email',                     isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: true},
                          {name: 'Телефон',       sqlName: 'Phone',                     isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: true},
                          {name: 'Skype',         sqlName: 'Skype',                     isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: false},
                          {name: 'Дата создания', sqlName: 'CreatedTS',                 isSorted: true,  isSortable: true, isDown: false, isSearched: false, isSearchable: false, filter: 'date'}];

        $scope.newstud.properties = [{name:'lastName'}, 
                                     {name:'firstName'},
                                     {name:'middleName'}, 
                                     {name:'company.shortName'},
                                     {name:'email'},
                                     {name:'phone'},
                                     {name:'skype'},
                                     {name:'createdTS', filter: 'date', filterParam: $filter('localize')('d MMMM y, HH:mm:ss')}];

        $scope.newstud.pageSize = UtilsSrvc.getPropertyValue($scope.pageStore, 'newstud.grid.pageSize', 10);
        $scope.newstud.pageCurr = UtilsSrvc.getPropertyValue($scope.pageStore, 'newstud.grid.pageCurr', 1);
        $scope.newstud.itemsTotal = 0;
        $scope.newstud.selectedItems = [];
        $scope.newstud.multiSelectMode = false;
        $scope.newstud.forciblyUpdate = 0;
        $scope.newstud.actionColumnVisible = true;

        //$scope.newstud.forciblyUpdate++;
        
        //============================== СТУДЕНТЫ ПОДГРУППЫ ==========================================================================
        $scope.student.columns = [{name: 'Фамилия'}, {name: 'Имя'}, {name: 'Отчество'}, {name: 'Организация'}, {name: 'Email'}, {name: 'Телефон'}, {name: 'Skype'}];
        $scope.student.properties = [{name:'lastName'}, {name:'firstName'}, {name:'middleName'}, {name:'company.shortName'}, {name:'email'}, {name:'phone'}, {name:'skype'}];
        $scope.student.pageSize = 100;
        $scope.student.pageCurr = 1;
        $scope.student.itemsTotal = 0;
        $scope.student.selectedItems = [];
        $scope.student.multiSelectMode = false; 


        //============================== ВСЕ СТУДЕНТЫ ==========================================================================
        $scope.allstud.columns = [
                          {name: 'Фамилия',       sqlName: 'Students->LastName->Value',           isSorted: false, isSortable: true, isDown: true,  isSearched: true,   isSearchable: true},
                          {name: 'Имя',           sqlName: 'Students->FirstName->Value',          isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: false},
                          {name: 'Отчество',      sqlName: 'Students->MiddleName->Value',         isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: false},
                          {name: 'Организация',      sqlName: 'Students->Company->ShortName->Value', isSorted: true,  isSortable: true, isDown: true,  isSearched: false,  isSearchable: true},
                          {name: 'Email',         sqlName: 'Students->Email',                     isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: true},
                          {name: 'Телефон',       sqlName: 'Students->Phone',                     isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: true},
                          {name: 'Skype',         sqlName: 'Students->Skype',                     isSorted: false, isSortable: true, isDown: true,  isSearched: false,  isSearchable: false}];

        $scope.allstud.properties = [{name:'lastName'}, {name:'firstName'}, {name:'middleName'}, {name:'company.shortName'}, {name:'email'}, {name:'phone'}, {name:'skype'}];
        $scope.allstud.pageSize = 15;
        $scope.allstud.pageCurr = 1;
        $scope.allstud.itemsTotal = 0;
        $scope.allstud.selectedItems = [];
        $scope.allstud.multiSelectMode = false;
        $scope.allstud.forciblyUpdate = 0;
    };



    // Загрузить обучение по ИД
    $scope.training.loadData = function(id){
        //console.log('msg: training.loadData');
        TrainingSrvc.getTraining(id).then(
            function(data){
                $scope.training.data = data;
                $scope.training.data.notCorrectAddress = data.address.title;
                $scope.training.data.isStudentsAutoMailing = $scope.training.data.isStudentsAutoMailing==0 ? false : true; 
                $scope.training.data.isTeacherAutoMailing = $scope.training.data.isTeacherAutoMailing==0 ? false : true; 

        		    $scope.training.dateStart = data.dateStart;
        		    $scope.training.dateFinish = data.dateFinish;
        		
                if (data.isCompleted == 0){
                    $scope.training.btnAdditionName = 'Завершить';
                	$scope.training.btnAdditionVisible = true;
                }
                else{
                    $scope.training.btnAdditionVisible = false;
                }
				
				        $scope.training.btnAdditionAction = $scope.training.complete;
                //$scope.sgroup.forciblyUpdate++;
                //$scope.allstud.forciblyUpdate++;

               

            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Обновить данные обучения
    $scope.training.save = function(){
	    TrainingSrvc.saveTraining($scope.training.data).then(
            function(data){
                $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Изменения сохранены.', 'success', true);
                $scope.trainingForm.$setPristine();
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Завершить обучение и создать сертификаты
    $scope.training.complete = function(){
        function complete (){
          TrainingSrvc.completeTraining($scope.training.data.id).then(
              function(data){
                  $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Обучение завершено.', 'success', true);
                  $route.reload();
              },
              function(response){
                  $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
              });
        }

         UtilsSrvc.openMessageBox('Завершение обучения', $filter('localize')("Завершить обучение и создать сертификаты для слушателей?"), complete);  
    };

    //===============================================================================================================================================================================
    // GROUP                                                                                                                                                                    GROUP
    //===============================================================================================================================================================================
    // Загрузить подгруппы
    $scope.sgroup.loadItems = function(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText){
        //console.log('msg: sgroup.loadItems');
        TrainingSrvc.getTrainingSubGroups(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText, $routeParams.id).then(
            function(data){
                $scope.sgroup.pageTotal = Math.ceil(data.itemsTotal / pageSize);
                $scope.sgroup.itemsTotal = data.itemsTotal;
                $scope.sgroup.items = data.items;
                $scope.training.data.sgroups = data.itemsTotal;

                if ($scope.sgroup.selectedItems && $scope.sgroup.items && $scope.sgroup.selectedItems.length == 0 && $scope.sgroup.items.length != 0){
                    $scope.sgroup.selectedItems[0] = $scope.sgroup.items[0];
                    $scope.sgroup.selectedItems[0].rowClass = 'info';
                }
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Загрузить валюты
    $scope.sgroup.loadCurrencies = function(){
        //console.log('msg: sgroup.loadCurrencies');
        TrainingSrvc.getCurrencies().then(
            function(data){
                $scope.sgroup.currencies = data;
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Сохранить платеж
    $scope.sgroup.savePayment = function(){
        TrainingSrvc.saveSubGroupPayment({id: $scope.sgroup.selectedItems[0].id, 
                                          currencyId: $scope.sgroup.selectedItems[0].currency.id, 
                                          amount: $scope.sgroup.selectedItems[0].amount,
                                          discount: $scope.sgroup.selectedItems[0].discount=='' ? 0: $scope.sgroup.selectedItems[0].discount}).then(
            function(data){
                $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Платеж для подгруппы сохранен.', 'success', true);
                $scope.sgPaymentForm.$setPristine();
                $scope.sgroup.modalPaymentVisible = false;
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });  
    };
    
    // Изменение величины скидки на обучение
    $scope.sgroup.changeDiscount = function(){
        if ($scope.sgroup.selectedItems[0].discount <= 100 && $scope.sgroup.selectedItems[0].discount >= 0){
            $scope.sgroup.selectedItems[0].amount = ($scope.training.data.cost.price - $scope.training.data.cost.price * ($scope.sgroup.selectedItems[0].discount / 100)).toFixed(2) * 1;    
        }
        else{
            $scope.sgroup.selectedItems[0].amount = $scope.sgroup.selectedItems[0].amountReal; 
        }
    };

    // Сохранить данные договора
    $scope.sgroup.saveContract = function(){
        TrainingSrvc.saveSubGroupContract($scope.sgroup.contract).then(
            function(data){
                $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Данные договора сохранены.', 'success', true);
                $scope.sgContractForm.$setPristine();
                $scope.sgroup.forciblyUpdate++;
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });  
    };

    // Отмена изменений платежа
    $scope.sgroup.cancelPayment = function(){
        if ($scope.sgPaymentForm.$pristine){
            $scope.sgroup.modalPaymentVisible = false;    
        }
        $scope.sgroup.forciblyUpdate++;
        $scope.sgPaymentForm.$setPristine();
    };

    // Отслеживание выбранной подгруппы
    $scope.$watch('sgroup.selectedItems[0].id', function(){
        if ($scope.sgroup.selectedItems.length != 0){
        	$scope.sgroup.contract = $scope.sgroup.selectedItems[0].contract;
        	$scope.sgroup.dateSt = $scope.sgroup.contract.dateStart;
        	$scope.sgroup.dateFn = $scope.sgroup.contract.dateFinish;

            if ($scope.sgroup.selectedItems[0].amount == $scope.training.data.cost.price && $scope.sgroup.selectedItems[0].currency.id == $scope.training.data.cost.currency.id){
                $scope.sgroup.selectedItems[0].discount = 0;
            }
        }
        
        if (!$scope.sgPaymentForm.$dirty)
            return;

        $scope.sgroup.forciblyUpdate++;
        $scope.sgPaymentForm.$setPristine();
    },true);

    // При изменении валюты в выбранной подгруппе
    $scope.$watch('sgroup.selectedItems[0].currency.id', function(){ 
        if (!$scope.sgroup.selectedItems[0])
        	return;
        	
        var idx = UtilsSrvc.getIndexes($scope.sgroup.currencies, 'id', $scope.sgroup.selectedItems[0].currency.id)
        
        if (idx.length == 0)
            return;
        
        $scope.sgroup.selectedItems[0].currency.name = $scope.sgroup.currencies[idx[0]].name;
    },true);

  

    // Удалить подгруппу из обучения
    $scope.sgroup.delete = function(item){
        function deleteSGroup(){
            TrainingSrvc.deleteSubGroup($scope.training.data.id, item.id).then(
                function(data){
	                $scope.sgroup.selectedItems = [];
                    $scope.sgroup.forciblyUpdate++;
                    $scope.allstud.forciblyUpdate++;
                    $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Подгруппа удалена.', 'success', true);
                },
                function(response){
                    $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
                });  
        };

        UtilsSrvc.openMessageBox('Удалить подгруппу', $filter('localize')("Удалить подгруппу плательщика") + ' ' + item.payer.shortName + "?", deleteSGroup);  
    };

    // Открыть модальное окно для создания новой подгруппы
    $scope.sgroup.add = function(){
        $('#AddSubGroupModal').modal('show');
        $scope.sgroup.modalAddSubGroupVisible = true;

        if (!$scope.sgroup.companies || $scope.sgroup.companies.length == 0)
            $scope.sgroup.loadCompanies();
    };

    // Добавить подгруппу в обучение
    $scope.sgroup.addSubGroup = function(){
        $scope.sgroup.modalAddSubGroupVisible = false;
        
        TrainingSrvc.createSubGroup({trainingId: $scope.training.data.id, 
                                     payerId: $scope.sgroup.newSubGroupPayer ? $scope.sgroup.newSubGroupPayer.id : ''}).then(
            function(data){
                $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Подгруппа добавлена.', 'success', true);
                $scope.sgroup.forciblyUpdate++;
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });  
    };

    /* Подгрузить имена компаний */
    $scope.sgroup.loadCompanies = function(){
        //console.log('msg: sgroup.loadCompanies');
        CompanySrvc.getAllCompaniesShortInfo().then(
            function(data){
                $scope.sgroup.companies = data;
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            }); 
    };


    // Перейти на страницу для добавления слушателя в подгруппу
    $scope.student.add = function(){
        $location.path('/person').search({type: 'sgstud', sgroup: $scope.sgroup.selectedItems[0].id, training: $scope.training.data.id});
    };
    
    // Перейти на страницу для редактирования слушателя в подгруппу
    $scope.student.edit = function(item){
        $location.path('/person').search({type: 'sgstud', id: item.id, training: $scope.training.data.id});
    };

    // Удалить слушателя из подгруппы
    $scope.student.delete = function(item){
        function deleteSGroupStudent(){
            PersonSrvc.deleteSubGroupStudent($scope.sgroup.selectedItems[0].id, item.id).then(
                function(data){
                    $scope.sgroup.forciblyUpdate++;
                    $scope.allstud.forciblyUpdate++;
                    $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Слушатель удален из подгруппы.', 'success', true);
                },
                function(response){
                    $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
                });  
        };

        UtilsSrvc.openMessageBox('Удалить слушателя', $filter('localize')("Удалить слушателя") + ' ' + item.lastName + "?", deleteSGroupStudent);   
    };

    // Отформатировать данные перед отправкой формы
    $scope.sgroup.formatData = function(){
        $scope.sgroup.contract.dateStart = UtilsSrvc.getValidDate($scope.sgroup.dateSt);
        if ($scope.sgroup.contract.dateStart == "")
            $scope.sgroup.dateSt = "";

        $scope.sgroup.contract.dateFinish = UtilsSrvc.getValidDate($scope.sgroup.dateFn);
        if ($scope.sgroup.contract.dateFinish == "")
            $scope.sgroup.dateFn = "";

        $scope.sgroup.contract.city = $scope.training.data.city;
        $scope.sgroup.contract.id = $scope.sgroup.selectedItems[0].id;
    };

    $scope.sgroup.selectTab = function(){
        if (!$scope.sgroup.items || $scope.sgroup.items.length==0)
            $scope.sgroup.forciblyUpdate++;

        if (!$scope.sgroup.currencies || $scope.sgroup.currencies.length==0)
            $scope.sgroup.loadCurrencies();
    };



    //===============================================================================================================================================================================
    // CERTIFICATES                                                                                                                                                      CERTIFICATES
    //===============================================================================================================================================================================
    // Загрузка сертификатов
    $scope.cert.loadItems = function(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText){
        //console.log('msg: cert.loadItems');
        TrainingSrvc.getCertificates(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText, $routeParams.id).then(
            function(data){
                $scope.cert.pageTotal = Math.ceil(data.itemsTotal / pageSize);
                $scope.cert.itemsTotal = data.itemsTotal;
                $scope.cert.items = data.items;
                $scope.training.data.certificates = $scope.cert.itemsTotal;
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Сменить статус печати
    $scope.cert.print = function(item){
         CertificateSrvc.print(item.number).then(
            function(data){
                //$scope.cert.alert = UtilsSrvc.getAlert('Готово!', 'Статус сертификата изменен.', 'success', true);
                $scope.cert.forciblyUpdate++;
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Удалить сертификат
    $scope.cert.remove = function(item){
        function removeCert(){
           CertificateSrvc.remove(item.number).then(
              function(data){
                  $scope.cert.forciblyUpdate++;
                  $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Сертификат удалён.', 'success', true);
              },
              function(response){
                  $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
              });
        };

        UtilsSrvc.openMessageBox('Удалить сертификат', $filter('localize')("Удалить сертификат слушателя") + " '" + item.student.lastName + "'?", removeCert); 
    };


    // Экспорт сертификатов
    $scope.cert.exportToCSV = function(){
        ReportSrvc.certificates($scope.training.data.id);
    };

    // Создать все сертификаты
    $scope.cert.createAll = function(){
         TrainingSrvc.createCertificates($routeParams.id).then(
            function(data){
                $scope.cert.forciblyUpdate++;
                $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Сертификаты обновлены.', 'success', true);
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    $scope.cert.selectTab = function(){
        if (!$scope.cert.items || $scope.cert.items.length==0)
            $scope.cert.forciblyUpdate++;
    };    



    //===============================================================================================================================================================================
    // NEW ORDERS                                                                                                                                                          NEW ORDERS     
    //===============================================================================================================================================================================
    // Загрузка новых слушателей
    $scope.newstud.loadItems = function(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText){
        //console.log('msg: newstud.loadItems');
        OrderSrvc.getOrdersNewStudent(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText, $routeParams.id).then(
            function(data){
                $scope.newstud.pageTotal = Math.ceil(data.itemsTotal / pageSize);
                $scope.newstud.itemsTotal = data.itemsTotal;
                $scope.newstud.items = data.items;
                $scope.training.data.newStudents = data.itemsTotal;

                if ($scope.newstud.selectedItems && $scope.newstud.items && $scope.newstud.selectedItems.length == 0 && $scope.newstud.items.length != 0){
                    $scope.newstud.selectedItems[0] = $scope.newstud.items[0];
                    $scope.newstud.selectedItems[0].rowClass = 'info';
                }
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Удалить заявку
    $scope.newstud.remove = function(item){
        function removeOrd(){
           OrderSrvc.deleteOrderNewStudent(item.id).then(
              function(data){
                  $scope.newstud.forciblyUpdate++;
                  $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Заявка от слушателя удалена.', 'success', true);
              },
              function(response){
                  $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
              });
        };

        UtilsSrvc.openMessageBox('Удалить заявку', $filter('localize')("Удалить заявку от слушателя") + " '" + item.lastName + "'?", removeOrd); 
    };

    // Вызов при каждом выборе студента
    $scope.$watch('newstud.selectedItems[0].id', function(){
        if ($scope.newstud.selectedItems.length == 0)
            return;

        PersonSrvc.getPersonByEmail($scope.newstud.selectedItems[0].email).then(
            function(data){
                $scope.newstud.conflict = data;
            },
            function(response){
                $scope.newstud.conflict = {};
            });
    },true);

    // Добавление слушателя из заявки в обучение
    $scope.newstud.addIntoTraining = function(type){
        TrainingSrvc.addNewStudentIntoTraining({orderId: $scope.newstud.selectedItems[0].id, trainingId: $scope.training.data.id, type: type}).then(
                function(data){
                    $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Слушатель из заявки добавлен в обучение.', 'success', true);
                    $scope.newstud.forciblyUpdate++;
                    $scope.sgroup.forciblyUpdate++;
                    $scope.allstud.forciblyUpdate++;
          
                    $scope.newstud.selectedItems = [];
                },
                function(response){
                    $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
                    $scope.newstud.forciblyUpdate++;
                    $scope.sgroup.forciblyUpdate++;
                    $scope.allstud.forciblyUpdate++;
          
                    $scope.newstud.selectedItems = [];
                });
    };

    // Открыть диалог смены компании в заявке
    $scope.other.openChangeCompanyDialog = function(){
        if (!$scope.sgroup.companies || $scope.sgroup.companies.length == 0)
            $scope.sgroup.loadCompanies();
        
        $('#ChangeCompanyModal').modal('show');
        $scope.other.modalChangeCompanyVisible = true;
    };

    // Изменение компании в заявке
    $scope.other.changeCompany = function(){
        $scope.other.modalChangeCompanyVisible = false;
        if (!$scope.other.newOrderCompany || !$scope.other.newOrderCompany.id)
            return;
        
        OrderSrvc.changeOrderNewStudentCompany($scope.newstud.selectedItems[0].id, $scope.other.newOrderCompany.id).then(
                function(data){
                    $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Произошла смена организации в заявке.', 'success', true);
                    $scope.newstud.forciblyUpdate++;
                },
                function(response){
                    $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
                });
    };

    // Переход на страницу создания компании
    $scope.other.createCompany = function(){
        $location.path('/company').search({ordernewstudent: $scope.newstud.selectedItems[0].id});
    };


    $scope.newstud.selectTab = function(){
        if (!$scope.newstud.items || $scope.newstud.items.length==0)
            $scope.newstud.forciblyUpdate++;
    };    



    //============================================================================================================================================================================
    // ALL STUDENTS                                                                                                                                                   ALL STUDENTS  
    //============================================================================================================================================================================
    // Загрузить всех слушателей
    $scope.allstud.loadItems = function(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText){
        //console.log('msg: allstud.loadItems');
        TrainingSrvc.getTrainingStudents(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText, $routeParams.id).then(
            function(data){
                $scope.allstud.pageTotal = Math.ceil(data.itemsTotal / pageSize);
                $scope.allstud.itemsTotal = data.itemsTotal;
                $scope.allstud.items = data.items;
                $scope.training.data.students = data.itemsTotal;

                if ($scope.allstud.selectedItems && $scope.allstud.items && $scope.allstud.selectedItems.length == 0 && $scope.allstud.items.length != 0){
                    $scope.allstud.selectedItems[0] = $scope.allstud.items[0];
                    $scope.allstud.selectedItems[0].rowClass = 'info';
                }
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Перейти на страницу для добавления слушателя в подгруппу
    $scope.allstud.add = function(){
        $location.path('/person').search({type: 'trng', training: $scope.training.data.id});
    };
    
    // Перейти на страницу для редактирования слушателя в подгруппу
    $scope.allstud.edit = function(item){
        $location.path('/person').search({type: 'trng', id: item.id, training: $scope.training.data.id});
    };

    // Удалить слушателя из подгруппы
    $scope.allstud.delete = function(item){
        function deleteTrainingStudent(){
            PersonSrvc.deleteTrainingStudent($scope.training.data.id, item.id).then(
                function(data){
                    $scope.sgroup.forciblyUpdate++;
                    $scope.allstud.forciblyUpdate++;
                    $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Слушатель удален из подгруппы.', 'success', true);
                },
                function(response){
                    $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
                });  
        };

        UtilsSrvc.openMessageBox('Удалить слушателя', $filter('localize')("Удалить слушателя") + ' ' + item.lastName + "?", deleteTrainingStudent);   
    };


    $scope.allstud.selectTab = function(){
        if (!$scope.allstud.items || $scope.allstud.items.length==0)
            $scope.allstud.forciblyUpdate++;
    };    

    //===========================================================================================================================================================================
    // Google Calendar                                                                                                                                            Google Calendar
    //===========================================================================================================================================================================
    // Load event by id or if id==null -> generate
    $scope.training.loadEvent = function(){
       TrainingSrvc.doEvent({method: "get", id: $routeParams.id}).then(
            function(data){
                data.event.description = data.event.description.replace(/<br>/g, "\n");
                $scope.training.eventData = data;
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Create event
    $scope.training.createEvent = function(){
       TrainingSrvc.doEvent({method: "create", id: $routeParams.id, event:  $scope.training.eventData.event}).then(
            function(data){
                $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Событие создано.', 'success', true);
                $scope.training.eventData.event.exists = 1;
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Update event
    $scope.training.updateEvent = function(){
       TrainingSrvc.doEvent({method: "update", id: $routeParams.id, event:  $scope.training.eventData.event}).then(
            function(data){
                $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Событие обновлено.', 'success', true);
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Delete event
    $scope.training.deleteEvent = function(){
        function deleteEvent(){
           TrainingSrvc.doEvent({method: "delete", id: $routeParams.id}).then(
                function(data){
                    //$scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Событие удалено.', 'success', true);
                    $scope.training.loadEvent();      
                    $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Событие удалено.', 'success', true);
                },
                function(response){
                    $scope.training.loadEvent();      
                    $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Событие удалено.', 'success', true);
                });
        };

        UtilsSrvc.openMessageBox('Удалить событие', "Удалить событие из календаря?", deleteEvent);   
    };


    //==============================================================================================================================================================================
    // Automailing                                                                                                                                                       Automailing
    //==============================================================================================================================================================================
    // Load all students emails
    $scope.mailing = {selectedType: 'students', types:[
                                                  {id: 'students', name: $filter('localize')('Слушатели - напоминание')}, 
                                                  {id: 'feedback', name: $filter('localize')('Слушатели - доступ к анкете')}, 
                                                  {id: 'teacher',  name: $filter('localize')('Преподаватель - доступ к списку слушателей')},
                                                  {id: 'curator',  name: $filter('localize')('Куратор - доступ к списку слушателей')}]};

    $scope.mailing.loadEmailContacts = function(){
        //console.log('msg: mailing.loadEmailContacts');
        TrainingSrvc.getEmailContacts($routeParams.id).then(
            function(data){
                $scope.mailing.contacts = data; 
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Delete email from recipient field
    $scope.mailing.deleteEmailContact = function(contact){
        var idx = UtilsSrvc.getIndexes($scope.mailing.contacts, 'id', contact.id);
                
        if (idx.length != 0)
            $scope.mailing.contacts.splice(idx[0], 1);
    };

    // Send email to training students or custom student (single email)
    $scope.mailing.sendEmail = function(isSingleEmail){
        var emails;

        if (isSingleEmail){
            if (!$scope.mailing.single || $scope.mailing.single == '') 
                return;

            emails = $scope.mailing.single;
        }
        else{
            if ($scope.mailing.selectedType=='students' || $scope.mailing.selectedType=='feedback'){
                emails = [];
                for (var i=0; i < $scope.mailing.contacts.length; i++)
                    emails.push($scope.mailing.contacts[i].email);

                if (emails.length == 0){
                    $scope.other.alert = UtilsSrvc.getAlert('Внимание!', 'Выберите получателей письма.', 'error', true);
                    return;
                }
            }
            else if ($scope.mailing.selectedType=='teacher'){
                emails = $scope.training.data.teacher.email;
            }
            else if ($scope.mailing.selectedType=='curator'){
                emails = $scope.training.data.curator.email;
            }             
        }

        if (!$scope.mailing.email.msg || $scope.mailing.email.msg == '') return;

        TrainingSrvc.sendEmail({emails: emails, subject: $scope.mailing.email.subject, msg: $scope.mailing.email.msg.replace(/\n/g, "<br>")}).then(
            function(data){
                $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Почта отправлена', 'success', true);
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

 
    // Off\On Automailing for training 
    $scope.mailing.changeStatus = function(){
        //console.log('msg: mailing.changeStatus');
        TrainingSrvc.changeStatusAutoMailing({id: $scope.training.data.id, isAutoMailing: $scope.mailing.status, type: $scope.mailing.selectedType}).then(
            function(data){
                $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Изменения сохранены.', 'success', true);
                switch($scope.mailing.selectedType){
                    case 'students':{
                        $scope.training.data.isStudentsAutoMailing = $scope.mailing.status;
                        break;
                    }
                    case 'teacher':{
                        $scope.training.data.isTeacherAutoMailing = $scope.mailing.status;
                        break;
                    }
                    case 'curator':{
                        $scope.training.data.isCuratorAutoMailing = $scope.mailing.status;
                        break;
                    }
                    case 'feedback':{
                        $scope.training.data.isFeedBackAutoMailing = $scope.mailing.status;
                        break;
                    }
                }  
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Change mail type in combobox
    $scope.mailing.changeType = function(){
        //console.log('msg: mailing.changeType');
        TrainingSrvc.getMailPattern($scope.mailing.selectedType).then(
            function(data){
                $scope.mailing.email = {subject: data.subject};

                switch($scope.mailing.selectedType){
                    case 'students':{
                        $scope.mailing.status = $scope.training.data.isStudentsAutoMailing==0 ? false : true;
                        $scope.mailing.email.msg = data.msg
                                                      .replace("%1", $filter('convertCacheDate')($scope.training.data.dateStart, $filter('localize')('d MMMM y')))
                                                      .replace("%2", $scope.training.data.course.name)
                                                      .replace("%3", $scope.training.data.city.name + ', ' + $scope.training.data.city.parentName + ', ' + $scope.training.data.city.greatParentName)
                                                      .replace("%4", $scope.training.data.address.title)
                                                      .replace("%5", $scope.training.data.room == "-" ? "" : (", " + $scope.training.data.room))
                                                      .replace("%6", $scope.training. data.timeStart + ' - ' + $scope.training.data.timeFinish)
                                                      .replace("%7", $scope.training.data.teacher.lastName + ' ' + $scope.training.data.teacher.firstName)
                                                      .replace("%8", $scope.training.data.otherInfo)
                                                      .replace(/<br>/g, "\n");
                      break;
                    }
                    case 'teacher':{
	                    var curatorData = '';
	                    if ($scope.training.data.curator.fullName != ''){
	                    	curatorData = $filter('localize')('Куратор') + ': ' + $scope.training.data.curator.fullName + ', ' + $scope.training.data.curator.email + ', ' + $scope.training.data.curator.phoneSecret;
	                    	if ($scope.training.data.otherInfo != ''){
	                    		curatorData = '\n' + curatorData;
	                    	}
	                    }
	                    
                        $scope.mailing.status = $scope.training.data.isTeacherAutoMailing==0 ? false : true;
                        $scope.mailing.email.msg = data.msg
                                                      .replace("%1", $location.host() + ":" + $location.port() + StcAppSetting['defaultApp'] + "/stc/index.csp?urlData=trainingstudents-q-id-eq-"+$scope.training.data.id + "-and-code-eq-"+$scope.training.data.accessCode)
                                                      .replace("%2", $filter('convertCacheDate')($scope.training.data.dateStart, $filter('localize')('d MMMM y')))
                                                      .replace("%4", $scope.training.data.course.name)
                                                      .replace("%5", $scope.training.data.city.name + ', ' + $scope.training.data.city.parentName + ', ' + $scope.training.data.city.greatParentName)
                                                      .replace("%6", $scope.training.data.address.title)
                                                      .replace("%7", $scope.training.data.room)
                                                      .replace("%3", $scope.training.data.timeStart + ' - ' + $scope.training.data.timeFinish)
                                                      .replace("%8", $scope.training.data.otherInfo)
                                                      .replace("%9", curatorData)
                                                      .replace(/<br>/g, "\n");
                      break;
                    }
                    case 'curator':{
                      $scope.mailing.status = $scope.training.data.isCuratorAutoMailing==0 ? false : true;
                      $scope.mailing.email.msg = data.msg
                                                      .replace("%1", $location.host() + ":" + $location.port() + StcAppSetting['defaultApp'] + "/stc/index.csp?urlData=trainingstudents-q-id-eq-"+$scope.training.data.id + "-and-code="+$scope.training.data.accessCode)
                                                      .replace("%2", $filter('convertCacheDate')($scope.training.data.dateStart, $filter('localize')('d MMMM y')))
                                                      .replace("%4", $scope.training.data.course.name)
                                                      .replace("%5", $scope.training.data.city.name + ', ' + $scope.training.data.city.parentName + ', ' + $scope.training.data.city.greatParentName)
                                                      .replace("%6", $scope.training.data.address.title)
                                                      .replace("%7", $scope.training.data.room)
                                                      .replace("%3", $scope.training.data.timeStart + ' - ' + $scope.training.data.timeFinish)
                                                      .replace("%8", $scope.training.data.teacher.lastName+' '+$scope.training.data.teacher.firstName + ', ' + $scope.training.data.teacher.phone + ', ' + $scope.training.data.teacher.email)
                                                      .replace("%9", $scope.training.data.otherInfo)
                                                      .replace(/<br>/g, "\n");
                      break;
                    }
                    case 'feedback':{
                      $scope.mailing.status = $scope.training.data.isFeedBackAutoMailing==0 ? false : true;
                      $scope.mailing.email.msg = data.msg
                                                      .replace("%1", $location.host() + ":" + $location.port() + StcAppSetting['defaultApp'] + "/stc/index.csp?urlData=feedback-q-id-eq-"+$scope.training.data.id + "-and-code="+$scope.training.data.accessCode.split('-')[0]+'-'+$scope.training.data.accessCode.split('-')[4])
                                                      .replace("%2", $scope.training.data.course.name)
                                                      .replace(/<br>/g, "\n");
                  
                      break;
                    }
                }  
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Select tab "Mailing"
    $scope.mailing.selectTab = function(){
        $scope.mailing.changeType();
        $scope.mailing.loadEmailContacts(); 
    };

    //=============================================================================================================================================================================
    // FeedBacks                                                                                                                                                          FeedBacks
    //=============================================================================================================================================================================
    // Load feedbacks
    $scope.feedBack.loadItems = function(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText){
        //console.log('msg: feedBack.loadItems');
        TrainingSrvc.getFeedBacks(pageCurr, pageSize, sqlName, isDown, searchSqlName, searchText, $routeParams.id).then(
            function(data){
                $scope.feedBack.pageTotal = Math.ceil(data.itemsTotal / pageSize);
                $scope.feedBack.itemsTotal = data.itemsTotal;
                $scope.feedBack.items = data.items;
                $scope.training.data.feedBacks.count = $scope.feedBack.itemsTotal;
                if ($scope.feedBack.selectedItems && $scope.feedBack.items && $scope.feedBack.selectedItems.length == 0 && $scope.feedBack.items.length != 0){
                    $scope.feedBack.selectedItems[0] = $scope.feedBack.items[0];
                    $scope.feedBack.selectedItems[0].rowClass = 'info';
                }
            },
            function(response){
                $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            });
    };

    // Select tab "FeedBacks"
    $scope.feedBack.selectTab = function(){
        //console.log('msg: feedBack.selectTab');
        $scope.feedBack.forciblyUpdate++;
    };

    // Remove feedback from student
    $scope.feedBack.remove = function(item){
        function deleteFeedBack(){
           TrainingSrvc.deleteFeedBack(item.id).then(
                function(data){
                    $scope.feedBack.selectedItems = [];
                    $scope.feedBack.forciblyUpdate++;    
                    $scope.other.alert = UtilsSrvc.getAlert('Готово!', 'Отзыв удален.', 'success', true);
                },
                function(response){      
                    $scope.other.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
                });
        };

        UtilsSrvc.openMessageBox('Удалить отзыв', "Вы уверены?", deleteFeedBack);   
    };    

    $scope.other.init();
    $scope.training.loadData($routeParams.id);
});

]]></CSP>
</Export>
