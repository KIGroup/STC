<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="stc/js/controllers/CompanyCtrl.js" application="/csp/four/" default="1"><![CDATA[
'use strict';
//dddddddf

/*===========================================================================================
Компания
===========================================================================================*/

controllersModule.controller('CompanyCtrl', function($scope, $routeParams, $timeout, $location, OrderSrvc, CompanySrvc, UtilsSrvc){
    if ($scope.menu.active) $scope.menu.active.css = "menuAfterActive";

    $scope.compForm = {form: {}, company: {}, contact: {}, visible: true};
   
    $scope.compForm.init = function(){
        if ($routeParams.id){
            $scope.compForm.caption = "Редактирование компании";
            $scope.compForm.loadCompany($routeParams.id);
        }
        else if ($routeParams.order){
            $scope.compForm.caption = "Создание компании из заявки";
            $scope.compForm.loadDirtyOrder($routeParams.order);
        }
    };

    // Загрузить новую заявку
    $scope.compForm.loadDirtyOrder = function(code){
        OrderSrvc.getDirtyOrder(code).then(
            function(data){
                $scope.compForm.company = {contact: {}};
                $scope.compForm.company.shortName = data.contact.company.shortName;
                $scope.compForm.company.site = data.contact.company.site;
           
                $scope.compForm.company.contact = data.contact;
            },
            function(response){
                $scope.compForm.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
            }); 
    };

    // Сохранить
    $scope.compForm.save = function(){
        // Создать компанию из заявки вместе с контактом
        if ($routeParams.order){
            CompanySrvc.saveCompanyFromOrder($scope.compForm.company, $routeParams.order).then(
                function(data){
                    $location.path('/orders');
                },
                function(response){
                    $scope.compForm.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
                    
                });
        }
        else if ($routeParams.id){
	        CompanySrvc.saveCompany($scope.compForm.company).then(
                function(data){
                    $scope.compForm.alert = UtilsSrvc.getAlert('Готово!', 'Изменения сохранены.', 'success', true);
                    $scope.compForm_form.$setPristine();
                },
                function(response){
                    $scope.compForm.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
                    
                });
	    }       
    };
    
    // Загрузить компанию
    $scope.compForm.loadCompany = function(id){
		CompanySrvc.getCompany(id).then(
                function(data){
                    $scope.compForm.company = data;
                },
                function(response){
                    $scope.compForm.alert = UtilsSrvc.getAlert('Внимание!', response.data, 'error', true);
                    
                });
	};

    // Редактировать контакт - переход
    $scope.compForm.editContact = function(){
        $location.path('/person').search({type: 'cont', id: $scope.compForm.company.contact.id});
    };

    // Сменить контакт - переход
    $scope.compForm.changeContact = function(){
        $location.path('/person').search({type: 'cont', comp: $scope.compForm.company.id});
    };
    
    $scope.compForm.init();
});

]]></CSP>
</Export>
