<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Stc.Data.MailingJournal">
<Super>%Persistent</Super>
<TimeCreated>63399,51994.978925</TimeCreated>

<Property name="CreatedTS">
<Type>%TimeStamp</Type>
<Required>1</Required>
</Property>

<Property name="RecipientEmail">
<Type>%String</Type>
<Required>1</Required>
<Parameter name="MAXLEN" value="500"/>
</Property>

<Property name="RecipientName">
<Type>%String</Type>
<Parameter name="MAXLEN" value="500"/>
</Property>

<Property name="Subject">
<Type>%Text</Type>
<Required>1</Required>
<Parameter name="MAXLEN" value="500"/>
</Property>

<Property name="Message">
<Type>%Text</Type>
<Required>1</Required>
<Parameter name="MAXLEN" value="9000"/>
</Property>

<Method name="Create">
<ClassMethod>1</ClassMethod>
<FormalSpec>email:%String,recipientName:%String,subject:%String,message:%Text</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	try{
		set obj = ..%New()
		set obj.CreatedTS = $ZDT($ZTS,3)
		set obj.Subject = subject
		set obj.Message = message
		set obj.RecipientEmail = email
		set obj.RecipientName = recipientName
		
		if (obj.RecipientName = ""){
			&sql(SELECT FullName INTO :obj.RecipientName FROM Stc_Data.Person WHERE Email = :email)
			
			if (obj.RecipientName = ""){
				&sql(SELECT LastName || ' ' || FirstName INTO :obj.RecipientName FROM Stc_Data.Order WHERE Email = :email)	
				
				if (obj.RecipientName = ""){
					&sql(SELECT FullName INTO :obj.RecipientName FROM Stc_Data.MailingItemApproved WHERE Email = :email)	
			
					if (obj.RecipientName = ""){
						&sql(SELECT FullName INTO :obj.RecipientName FROM Stc_Data.MailingItemDirty WHERE Email = :email)	
					}
				}
			}
		}
		
		do obj.%Save()
	}
	catch(ex){
	}
	
	quit $$$OK
]]></Implementation>
</Method>

<Method name="ConvertToProxyObject">
<ReturnType>%ZEN.proxyObject</ReturnType>
<Implementation><![CDATA[
	set proxy = ##class(%ZEN.proxyObject).%New()
	
	set proxy.createdTS = ..CreatedTS
	set proxy.subject = ..Subject
	set proxy.message = ..Message
	
	set proxy.recipient = ##class(%ZEN.proxyObject).%New()
	set proxy.recipient.name = ..RecipientName
	set proxy.recipient.email = ..RecipientEmail
	
	quit proxy
]]></Implementation>
</Method>
</Class>
</Export>
