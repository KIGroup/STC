<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Stc.Data.Training">
<Description>
Training</Description>
<Super>%Persistent</Super>
<TimeCreated>63098,13359.879291</TimeCreated>

<Property name="Teacher">
<Description>
Teacher</Description>
<Type>Person</Type>
<Required>1</Required>
</Property>

<Property name="Course">
<Description>
Course</Description>
<Type>Course</Type>
<Required>1</Required>
</Property>

<Property name="SubGroups">
<Description>
Subgroups with students</Description>
<Type>SubGroup</Type>
<Collection>array</Collection>
</Property>

<Property name="City">
<Description>
City of training</Description>
<Type>Region</Type>
<Required>1</Required>
</Property>

<Property name="Street">
<Description>
Address</Description>
<Type>Stc.Data.Localization.LText</Type>
<Required>1</Required>
</Property>

<Property name="Room">
<Description>
Room</Description>
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="Latitude">
<Description>
Latitude</Description>
<Type>%Float</Type>
<Required>1</Required>
</Property>

<Property name="Longitude">
<Description>
Longitude</Description>
<Type>%Float</Type>
<Required>1</Required>
</Property>

<Property name="DateStart">
<Description>
Training start date</Description>
<Type>%Date</Type>
<Required>1</Required>
<Parameter name="FORMAT" value="3"/>
</Property>

<Property name="DateFinish">
<Description>
Training finish date</Description>
<Type>%Date</Type>
<Required>1</Required>
<Parameter name="FORMAT" value="3"/>
</Property>

<Property name="TimeStart">
<Description>
Training start time</Description>
<Type>%Time</Type>
<Required>1</Required>
</Property>

<Property name="TimeFinish">
<Description>
Training finish time</Description>
<Type>%Time</Type>
<Required>1</Required>
</Property>

<Property name="IsCompleted">
<Description>
Training is finished</Description>
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
<Required>1</Required>
</Property>

<Property name="IsStudentsAutoMailing">
<Description>
Automailing to students in n - days before start</Description>
<Type>%Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="IsTeacherAutoMailing">
<Description>
Automailing to teachers in n - days before start</Description>
<Type>%Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="OtherInfo">
<Description>
Other information</Description>
<Type>Stc.Data.Localization.LText</Type>
<Required>1</Required>
</Property>

<Property name="CalendarEvent">
<Description>
EventId Google Calendar</Description>
<Type>%String</Type>
<Parameter name="MAXLEN" value="500"/>
</Property>

<Property name="NewStudents">
<Description>
New applications from students for this certain training</Description>
<Type>Stc.Data.OrderNewStudent</Type>
<Cardinality>many</Cardinality>
<Inverse>Training</Inverse>
<Relationship>1</Relationship>
</Property>

<Property name="AccessCode">
<Description>
Access code to training for teacher</Description>
<Type>%String</Type>
</Property>

<Index name="AccessCodeIdx">
<Properties>AccessCode</Properties>
<Unique>1</Unique>
</Index>

<Method name="ConvertToProxyObject">
<Description>
Convert to proxyObject (for JSON)</Description>
<FormalSpec>shortInfo:%Boolean=0</FormalSpec>
<ReturnType>%ZEN.proxyObject</ReturnType>
<Implementation><![CDATA[
	set proxy = ##class(%ZEN.proxyObject).%New()
	set proxy.id = ..%Id()
	set proxy.accessCode = ..AccessCode
	set proxy.event = ..CalendarEvent
	set proxy.city = ..City.ConvertToProxyObject()
	set proxy.course = ..Course.ConvertToProxyObject(1)
	set proxy.teacher = ..Teacher.ConvertToProxyObject()
	set proxy.dateStart = $ZDATE(..DateStart, 3)
	set proxy.dateFinish = $ZDATE(..DateFinish, 3)
	set proxy.isCompleted = ..IsCompleted	
	
	set proxy.timeStart = $e(##class(%Library.Time).LogicalToDisplay(..TimeStart), 1, 5)
	set proxy.timeFinish = $e(##class(%Library.Time).LogicalToDisplay(..TimeFinish), 1, 5)
	set proxy.timeStartFinish = proxy.timeStart_" - "_proxy.timeFinish
	
	set proxy.otherInfo = ..OtherInfo.Value
	set proxy.room = ..Room
	set proxy.address = ##class(%ZEN.proxyObject).%New()
	set proxy.address.title = ..Street.Value
	set proxy.address.point = ..Latitude_" "_..Longitude
	set proxy.isStudentsAutoMailing = ..IsStudentsAutoMailing
	set proxy.isTeacherAutoMailing = ..IsTeacherAutoMailing

	if (shortInfo = 1) quit proxy
	
	set proxy.email = ##class(%ZEN.proxyObject).%New()
	set proxy.email.teacher = ##class(%ZEN.proxyObject).%New()
	set proxy.email.teacher.msg = ##class(Stc.Utils.Msg).GetMsg("msgToTrainingTeacher")
	set proxy.email.teacher.subject = ##class(Stc.Utils.Msg).GetMsg("msgSubjectToTrainingTeacher")
	
	set proxy.email.students = ##class(%ZEN.proxyObject).%New()
	set proxy.email.students.msg = ##class(Stc.Utils.Msg).GetMsg("msgToTrainingStudents")
	set proxy.email.students.subject = ##class(Stc.Utils.Msg).GetMsg("msgSubjectToTrainingStudents")
	
	
	set proxy.newStudents = ..NewStudents.Count()
	set proxy.sgroups = ..SubGroups.Count()
	set proxy.students = 0

	set key = ""
	for i=1:1:..SubGroups.Count(){
		set key = ..SubGroups.Next(key)
		set sgroup = ..SubGroups.GetAt(key)
		
		set proxy.students = proxy.students + sgroup.Students.Count()
	}
	
	// Training's cost and currency
	set proxy.cost = ##class(%ZEN.proxyObject).%New()
	set proxy.cost.price = ..Course.Price
	set proxy.cost.currency = ..Course.Currency.ConvertToProxyObject()
	
	quit proxy
]]></Implementation>
</Method>

<Method name="Save">
<Description>
Create or save modified training</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[data:%RegisteredObject,&status]]></FormalSpec>
<ReturnType>Training</ReturnType>
<Implementation><![CDATA[
	if (data.id = ""){
		set tr = ..%New()
		set tr.Street = ##class(Stc.Data.Localization.LText).Create($ZCONVERT(data.address.title, "I","UTF8"))
		set tr.OtherInfo = ##class(Stc.Data.Localization.LText).Create($ZCONVERT(data.otherInfo, "I","UTF8"))
		set status = tr.AddSubGroupsFromOrders(data.orders)
		quit:$$$ISERR(status) tr
	}
	else{
		set tr = ..%OpenId(data.id)
		set tr.Street.Value = $ZCONVERT(data.address.title, "I","UTF8")
		set tr.OtherInfo.Value = $ZCONVERT(data.otherInfo, "I","UTF8")
	}
	
	set tr.AccessCode = $SYSTEM.Util.CreateGUID()
	set tr.DateFinish = $ZDATEH(data.dateFinish, 15)
	set tr.DateStart = $ZDATEH(data.dateStart, 15)
	set tr.TimeFinish = ##class(%Library.Time).DisplayToLogical(data.timeFinish)
	set tr.TimeStart = ##class(%Library.Time).DisplayToLogical(data.timeStart)
	set tr.Room = $ZCONVERT(data.room, "I","UTF8")
	set tr.Latitude = $p(data.address.point, " ", 2)
	set tr.Longitude = $p(data.address.point, " ", 1)
	
	set tr.Course = ##class(Course).%OpenId(data.course.id)
	set tr.Teacher = tr.Course.Teachers.GetAt(data.teacher.id) // ##class(Person).%OpenId(data.teacher.id)
	set tr.City = ##class(Region).%OpenId(data.city.id)
	
	set status = tr.%Save()
	quit tr
]]></Implementation>
</Method>

<Method name="AddSubGroupsFromOrders">
<Description>
Add new subgroups to trainings from applications</Description>
<FormalSpec>orders:%ListOfObjects</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	for i=1:1:orders.Count(){
		set order = ##class(OrderApproved).%OpenId(orders.GetAt(i))
		set sub = ##class(SubGroup).Create(order.Company, order.Students, order.Course, .status)
		if $$$ISERR(status) RETURN ##class(Stc.Utils.Msg).GetErrorStatus("createSubGroup" ," | "_status) 	
			
		do ..SubGroups.SetAt(sub, sub.%Id())
		
		// Close app - all students in training
		set order.OrderStatus = ##class(OrderStatus).CodeIdxOpen("Closed")
		set status = order.%Save()
		if $$$ISERR(status) RETURN ##class(Stc.Utils.Msg).GetErrorStatus("saveSubGroup" ," | "_status) 	
	}
	
	quit $$$OK
]]></Implementation>
</Method>

<Method name="DeleteSubGroup">
<Description>
Delete subgroup from training, without deleting students</Description>
<FormalSpec>sgId:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ..SubGroups.RemoveAt(sgId)
	
	set sgroup = ##class(Stc.Data.SubGroup).%OpenId(sgId)
	
	set st = ##class(Stc.Data.Localization.LText).Delete(sgroup.SignerFullName.%Id())
	quit:$$$ISERR(st) st
	
	set st = ##class(Stc.Data.Localization.LText).Delete(sgroup.DocumentInfo.%Id())
	quit:$$$ISERR(st) st
	
	quit ##class(Stc.Data.SubGroup).%DeleteId(sgId)
]]></Implementation>
</Method>

<Method name="CreateCertificates">
<Description>
Create certificates for all students</Description>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set listOfStudents = ##class(%ListOfObjects).%New()
	
	set keyGr = ""
	for i=1:1:..SubGroups.Count(){
		set keyGr = ..SubGroups.Next(keyGr)
		set sgroup = ..SubGroups.GetAt(keyGr)
			
		set keySt = ""
		for j=1:1:sgroup.Students.Count(){
			set keySt = sgroup.Students.Next(keySt)
			set student = sgroup.Students.GetAt(keySt)
				
			do listOfStudents.Insert(student)
		}
	}
	
	quit ##class(Stc.Data.Certificate).CreateAll($this, listOfStudents)
]]></Implementation>
</Method>

<Method name="Delete">
<Description>
Delete training with applications</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	
	set training = ..%OpenId(id, 4)
	
	set key = ""
	for i=1:1:training.NewStudents.Count(){
		set key = training.NewStudents.Next(key)
		set order = training.NewStudents.GetAt(key)
		set st = ##class(Stc.Data.OrderNewStudent).Delete(order.%Id())
		if $$$ISERR(st) RETURN st
	}
	
	set st = ##class(Stc.Data.Localization.LText).Delete(training.Street.%Id())
	quit:$$$ISERR(st) st
	
	set st = ##class(Stc.Data.Localization.LText).Delete(training.OtherInfo.%Id())
	quit:$$$ISERR(st) st
	
	kill training
	
	quit ..%DeleteId(id, 4)
]]></Implementation>
</Method>

<Method name="AddPersonIntoTraining">
<Description>
Add person to training, subgroup is detirmining automatically</Description>
<FormalSpec>personId:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set status = $$$OK
	
	set trainingId = ..%Id()
	
	// Search student in training to avoid situation, 
	// when student in two different subgroups of one training
	set contains = 0
	&sql(SELECT COUNT(ID) INTO :contains
		 FROM Stc_Data.SubGroup_Students
		 WHERE SubGroup IN (SELECT $PIECE(ID,'||',2) 
		 					FROM Stc_Data.Training_SubGroups 
		 					WHERE Training = :trainingId) 
		 				AND Students = :personId)
	
	 
	if (contains '= 0) quit ##class(Stc.Utils.Msg).GetErrorStatus("personContainsInTraining")
	
	// If training has no this person, maybe training his organization's subgroup
	set person = ##class(Stc.Data.Person).%OpenId(personId)
	set personCompanyId = person.Company.%Id()
	set sgroupId = ""
	
	&sql(SELECT $PIECE(ID,'||',2) INTO :sgroupId FROM Stc_Data.Training_SubGroups WHERE Training = :trainingId AND SubGroups->Payer = :personCompanyId)
	
	if (sgroupId = ""){
		// If training has no organization's subgroup, create subgroup and add person to it
		set array = ##class(%ArrayOfObjects).%New()
		do array.SetAt(person, personId)
		set sgroup = ##class(Stc.Data.SubGroup).Create(person.Company, array, ..Course, .status)
		
		if $$$ISERR(status) quit status
		
		do ..SubGroups.SetAt(sgroup, sgroup.%Id())
	}
	else{
		// If training has organization's subgroup, just add person to it
		set group = ..SubGroups.GetAt(sgroupId)
		do group.Students.SetAt(person, personId)
		set status = group.%Save()
		
		if $$$ISERR(status) quit status
	}
	
	quit status
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^Stc.Data.TrainingD</DataLocation>
<DefaultData>TrainingDefaultData</DefaultData>
<IdLocation>^Stc.Data.TrainingD</IdLocation>
<IndexLocation>^Stc.Data.TrainingI</IndexLocation>
<StreamLocation>^Stc.Data.TrainingS</StreamLocation>
<ExtentSize>100000</ExtentSize>
<Data name="SubGroups">
<Attribute>SubGroups</Attribute>
<Structure>subnode</Structure>
<Subscript>"SubGroups"</Subscript>
</Data>
<Data name="TrainingDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>Teacher</Value>
</Value>
<Value name="3">
<Value>City</Value>
</Value>
<Value name="4">
<Value>Course</Value>
</Value>
<Value name="5">
<Value>Street</Value>
</Value>
<Value name="6">
<Value>Room</Value>
</Value>
<Value name="7">
<Value>Latitude</Value>
</Value>
<Value name="8">
<Value>Longitude</Value>
</Value>
<Value name="9">
<Value>TrainingTS</Value>
</Value>
<Value name="10">
<Value>DateStart</Value>
</Value>
<Value name="11">
<Value>DateFinish</Value>
</Value>
<Value name="12">
<Value>TimeStart</Value>
</Value>
<Value name="13">
<Value>TimeFinish</Value>
</Value>
<Value name="14">
<Value>OtherInfo</Value>
</Value>
<Value name="15">
<Value>IsCompleted</Value>
</Value>
<Value name="16">
<Value>SubGroupNumber</Value>
</Value>
<Value name="17">
<Value>CalendarEvent</Value>
</Value>
<Value name="18">
<Value>IsAutoMailing</Value>
</Value>
<Value name="19">
<Value>AccessCode</Value>
</Value>
<Value name="20">
<Value>IsStudentsAutoMailing</Value>
</Value>
<Value name="21">
<Value>IsTeacherAutoMailing</Value>
</Value>
</Data>
</Storage>
</Class>
</Export>
